<!DOCTYPE html>
<html lang="en">
<head>
    <title>Affordable Housing Map of Canada</title>
    <meta property="og:description" content="When a user hovers over a custom marker, show a popup containing more information." />
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- External CSS and JS libraries -->
    <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@4.3.0/dist/maplibre-gl.css' />
    <script src='https://unpkg.com/maplibre-gl@4.3.0/dist/maplibre-gl.js'></script>
    <!-- Internal CSS -->
    <style>
        body { margin: 0; padding: 0; }
        html, body, #map { height: 95%; }
        h1 {
            border-spacing: 1px;
            padding-left: 1%;
            font-family: Verdana, Geneva, Tahoma, sans-serif; 
        }

        .legend {
            background-color: #000;
            border-radius: 3px;
            bottom: 70px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            color: #fff ;
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            padding: 10px;
            position: absolute;
            left: 20px;
            z-index: 1;
        }

        .legend h4 {
            margin: 0 0 10px;
        }

        .legend div span {
            border-radius: 50%;
            display: inline-block;
            height: 10px;
            margin-right: 5px;
            width: 10px;
        }

        /* Add a canvas element on the left side */
        #info-canvas {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 300px;
            height: 150px;
            border: 1px solid #ddd;
            background-color: white;
            z-index: 2;
            padding: 10px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <h1>Affordable Housing Map of Canada</h1>
    
    <!-- Map Container -->
    <div id='map'></div>   

    <!-- Overlay Divs for Sidebar and Legend -->
    <div class='map-overlay' id='sidebar'></div>
    <div class='map-overlay' id='legend'></div>

    <div id="state-legend" class="legend"> 
        <h4>Median Total Income in 2020</br>Among Census Recipients ($) </h4>
          <div><span style="background-color: #E0ECF4"></span>&#60;20000</div>
          <div><span style="background-color: #BFD3E6"></span>40000</div>
          <div><span style="background-color: #8C96C6"></span>60000</div>
          <div><span style="background-color: #8C6BB1"></span>80000</div>
          <div><span style="background-color: #810F7C"></span>100000</div>
          <div><span style="background-color: #4D004B"></span>&gt;120000</div>
      </div>

    <!-- Information Canvas -->
    <div id="info-canvas"></div>
    
    <!-- JavaScript -->
    <script>
        const map = new maplibregl.Map({
            container: "map",
            style: "https://api.maptiler.com/maps/ch-swisstopo-lbm-dark/style.json?key=yyLFvKmMAkOmBAVbj4mk",
            center: [-79.3832, 43.6532],
            zoom: 3,
        });

        let hoveredStateId = null;

        map.on("load", async () => {
            try {
                // Function to load image and colorize
                const loadImage = (src) => {
                    return new Promise((resolve, reject) => {
                        const img = new Image();
                        img.crossOrigin = "anonymous";
                        img.onload = () => resolve(img);
                        img.onerror = (err) => reject(err);
                        img.src = src;
                    });
                };

                // Load house icon
                const houseIcon = await loadImage("home.png");
                const canvas = document.createElement("canvas");
                canvas.width = houseIcon.width;
                canvas.height = houseIcon.height;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(houseIcon, 0, 0, houseIcon.width, houseIcon.height);

                // Colorize the house icon to #BED2E6
                const imageData = ctx.getImageData(0, 0, houseIcon.width, houseIcon.height);
                const data = imageData.data;
                for (let i = 0; i < data.length; i += 4) {
                    // Check if the pixel is black (assuming the original icon has black parts)
                    if (data[i] === 0 && data[i + 1] === 0 && data[i + 2] === 0) {
                        // Replace black with #BED2E6 (RGB values)
                        data[i] = 190;   // R
                        data[i + 1] = 210; // G
                        data[i + 2] = 230; // B
                    }
                }
                ctx.putImageData(imageData, 0, 0);

                // Get the colorized image data
                const houseIconData = ctx.getImageData(0, 0, houseIcon.width, houseIcon.height);
                map.addImage("house-icon", houseIconData);

                console.log("House icon loaded, colored (#BED2E6), and added successfully");

                // Function to add CensusMapper data with income information
                async function addCensusMapperData() {
                    const censusMapperUrl = 'https://censusmapper.ca/api/v1/geo.geojson?dataset=CA21&regions={%22CSD%22:[%225915022%22,%222466112%22,%222466117%22,%222466127%22,%222466023%22,%222466102%22,%222466107%22,%222466142%22,%222466097%22,%222466087%22,%222466072%22,%222466007%22,%222466058%22,%222466032%22,%222466062%22,%222466047%22,%223506008%22,%223520005%22,%224611040%22,%224806016%22],%22CD%22:[%221203%22,%221202%22,%221201%22,%221204%22,%221205%22,%221207%22,%221206%22,%221208%22,%221209%22,%221210%22,%221212%22,%221214%22,%221213%22,%221216%22,%221217%22,%221218%22,%221215%22,%221211%22]}&level=CT&api_key=CensusMapper_a663240ee567b8e87e4ddd6270be6edc';
                    const incomeDataUrl = 'Data Income List.json';

                    const [geoResponse, incomeResponse] = await Promise.all([
                        fetch(censusMapperUrl),
                        fetch(incomeDataUrl)
                    ]);

                    const censusData = await geoResponse.json();
                    const incomeData = JSON.parse(await incomeResponse.text());

                    console.log(typeof(incomeData))
                    censusData.features.map((e)=>{
                    const id =e.properties.id
                    // search for the id in the other dataset
                    let result = incomeData.filter((e)=> parseFloat(e.GeoUID) === parseFloat(id))
                    result[0]["householdIncome"] = parseFloat(result[0]["v_CA21_906: Median total income of household in 2020 ($)"])
                    console.log(result)
                    e.properties={...e.properties, ...result[0]}
                    e.id=e.properties.id
                    return e
                    })
                    console.log(censusData)
                

                    map.addSource('regions', {
                        'type': 'geojson',
                        'data': censusData  
                    });

                    map.addLayer({
                        'id': 'states-layer',
                        'source': 'regions',
                        'type': 'fill',
                        'paint': {
                            'fill-color': [
                                'interpolate',
                                ['linear'],
                                ['get', 'householdIncome'],
                                20000,
                                '#E0ECF4',
                                40000,
                                '#BFD3E6',
                                60000,
                                '#8C96C6',
                                80000,
                                '#8C6BB1',
                                100000,
                                '#810F7C',
                                120000,
                                '#4D004B'
                            ],
                            'fill-opacity': 0.6
                        }
                    });

                    // Add hover interaction to display income data on the canvas
                    map.on('mousemove', 'states-layer', (e) => {
                        if (e.features.length > 0) {
                            if (hoveredStateId) {
                                map.setFeatureState(
                                    { source: 'regions', id: hoveredStateId },
                                    { hover: false }
                                );
                            }
                            hoveredStateId = e.features[0].id;
                            map.setFeatureState(
                                { source: 'regions', id: hoveredStateId },
                                { hover: true }
                            );
                            
                            const properties = e.features[0].properties;
                            updateCanvas(properties);
                        }
                    });

                    map.on('mouseleave', 'states-layer', () => {
                        if (hoveredStateId) {
                            map.setFeatureState(
                                { source: 'regions', id: hoveredStateId },
                                { hover: false }
                            );
                        }
                        hoveredStateId = null;
                        clearCanvas();
                    });
                }

                await addCensusMapperData();

                async function addDataToSource() {
                    const cityDataUrls = [
                        { url: "toronto.json", name: "Toronto" },
                        { url: "vancouver.json", name: "Vancouver" },
                        { url: "montreal.json", name: "Montreal" },
                        { url: "calgary.json", name: "Calgary" },
                        { url: "ottawa.json", name: "Ottawa" },
                        { url: "edmonton.json", name: "Edmonton" }
                    ];

                    for (const city of cityDataUrls) {
                        const response = await fetch(city.url);
                        const data = await response.json();
                        console.log(city.name, "Data:", data);
                        map.addSource(city.name, {
                            type: "geojson",
                            data: data,
                            cluster: true,
                            clusterMaxZoom: 14,
                            clusterRadius: 50,
                        });

                        map.addLayer({
                            id: `${city.name}-clusters`,
                            type: "circle",
                            source: city.name,
                            filter: ["has", "point_count"],
                            paint: {
                                "circle-color": "#51bbd6",
                                "circle-radius": [
                                    "step",
                                    ["get", "point_count"],
                                    20,
                                    100,
                                    30,
                                    750,
                                    40,
                                ],
                            },
                        });

                        map.addLayer({
                            id: `${city.name}-cluster-count`,
                            type: "symbol",
                            source: city.name,
                            filter: ["has", "point_count"],
                            layout: {
                                "text-field": "{point_count_abbreviated}",
                                "text-font": ["DIN Offc Pro Medium", "Arial Unicode MS Bold"],
                                "text-size": 12,
                            },
                        });

                        map.addLayer({
                            id: `${city.name}-unclustered-point`,
                            type: "symbol",
                            source: city.name,
                            filter: ["!", ["has", "point_count"]],
                            layout: {
                                "icon-image": "house-icon",
                                "icon-size": 1.5,
                                "icon-anchor": "bottom",
                                "text-field": ["get", "Address"],
                                "text-offset": [0, 0.6],
                                "text-anchor": "top",
                                "text-size": 12,
                                "text-transform": "uppercase",
                                "text-letter-spacing": 0.05,
                                "text-font": ["DIN Offc Pro Medium", "Arial Unicode MS Bold"],
                            },
                            paint: {
                                "text-color": "#ffffff",
                            },
                        });

                        map.on("click", `${city.name}-clusters`, (e) => {
                            const features = map.queryRenderedFeatures(e.point, {
                                layers: [`${city.name}-clusters`],
                            });
                            const clusterId = features[0].properties.cluster_id;
                            map.getSource(city.name).getClusterExpansionZoom(clusterId, (err, zoom) => {
                                if (err) return;

                                map.easeTo({
                                    center: features[0].geometry.coordinates,
                                    zoom: zoom,
                                });
                            });
                        });

                        map.on("click", `${city.name}-unclustered-point`, (e) => {
                            const coordinates = e.features[0].geometry.coordinates.slice();
                            const address = e.features[0].properties.Address;
                            const status = e.features[0].properties.Status;
                            const proposedUnits = e.features[0].properties.Proposed_units;
                            const socialHousingUnits = e.features[0].properties.Social_housing_units;
                            const affordableUnits = e.features[0].properties.Affordable_units;
                            const approvedDate = e.features[0].properties.APPROVED_DATE;
                            const byLawStatus = e.features[0].properties.BYLAW_STATUS;

                            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                                coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                            }

                            const popupContent = `
                                <h3>${address}</h3>
                                <p>Status: ${status}</p>
                                <p>Proposed Units: ${proposedUnits}</p>
                                <p>Social Housing Units: ${socialHousingUnits}</p>
                                <p>Affordable Units: ${affordableUnits}</p>
                                ${approvedDate ? `<p>Approved Date: ${approvedDate}</p>` : ''}
                                ${byLawStatus ? `<p>By-law Status: ${byLawStatus}</p>` : ''}
                            `;

                            new maplibregl.Popup()
                                .setLngLat(coordinates)
                                .setHTML(popupContent)
                                .addTo(map);
                        });

                        map.on("mouseenter", `${city.name}-unclustered-point`, () => {
                            map.getCanvas().style.cursor = "pointer";
                        });

                        map.on("mouseleave", `${city.name}-unclustered-point`, () => {
                            map.getCanvas().style.cursor = "";
                        });
                    }
                }

                await addDataToSource();
            } catch (error) {
                console.error("Error:", error);
            }
        });

        // Function to update canvas with income data
        function updateCanvas(properties) {
            const canvas = document.getElementById('info-canvas');
            canvas.innerHTML = `
                <h4>Region Information</h4>
                <p><strong>ID:</strong> ${properties.id}</p>
                <p><strong>Median Income:</strong> $${properties.householdIncome ? properties.householdIncome.toLocaleString() : 'N/A'}</p>
                <p><strong>Other Data:</strong> ${properties.otherData ? properties.otherData : 'N/A'}</p>
            `;
        }

        // Function to clear the canvas when the user is not hovering
        function clearCanvas() {
            const canvas = document.getElementById('info-canvas');
            canvas.innerHTML = '<h4>Hover over a region to see details</h4>';
        }

    </script>
</body>
</html>
